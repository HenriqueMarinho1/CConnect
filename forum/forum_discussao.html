<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fórum de Discussão</title>
  <style>
    body {
      background-color: #1e1e1e;
      color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      font-family: Arial, sans-serif;
      margin: 0;
    }

    .card {
      max-width: 600px;
      width: 100%;
      background-color: #292929;
      border-radius: 8px;
      overflow: hidden;
    }

    .card-header, .card-footer {
      padding: 16px;
      border-bottom: 1px solid #444;
    }

    .card-title {
      font-size: 1.5rem;
      color: #ffb400;
    }

    .icon {
      width: 1rem;
      height: 1rem;
      margin-right: 4px;
    }

    .card-content {
      max-height: 400px;
      overflow-y: auto;
      padding: 16px;
    }

    .message {
      display: flex;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .avatar {
      position: relative;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #444;
      margin-right: 12px;
    }

    .message-info {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    .username {
      font-weight: bold;
      color: #ffb400;
    }

    .timestamp {
      font-size: 0.75rem;
      color: #666;
      margin-left: 12px;
    }

    .message-text {
      margin-top: 4px;
      color: #ccc;
    }

    .replying-to {
      font-size: 0.875rem;
      color: #ccc;
    }

    .hidden {
      display: none;
    }

    .card-footer {
      display: flex;
      align-items: center;
    }

    #message-form {
      display: flex;
      width: 97%;
    }

    #mensagem_enviar {
      flex: 1;
      background-color: #333;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 8px;
      color: #fff;
    }

    .send-button {
        position: relative;
      background-color: #ffb400;
      border: none;
      border-radius: 4px;
      padding: 8px;
      cursor: pointer;
      left: 3%;
    }

    .send-button:hover {
      background-color: #e5a200;
    }
  </style>
</head>
<body>
  <div class="card">
    <header class="card-header">
      <h1 class="card-title">Fórum de Discussão</h1>
    </header>
    <div class="card-content" id="messages-container"></div>
    <footer class="card-footer">
      <div id="replying-to" class="replying-to hidden"></div>
      <form id="message-form">
        <input type="text" id="mensagem_enviar" placeholder="Digite sua mensagem..." required>
        <button type="submit" class="send-button">
          <svg class="icon"><!-- Ícone de enviar aqui --></svg>
        </button>
      </form>
    </footer>
  </div>

  <script>
    let messages = [];

    async function loadMessages() {
      try {
        const response = await fetch('./controller/controllerChat.php?action=Consultar');
        const data = await response.json();

        if (data.status === 1) {
          messages = data.dados.map(msg => ({
            id: msg.id,
            user: msg.usuario,
            avatar: "placeholder.png",
            message: msg.mensagem,
            online: true,
            timestamp: new Date(msg.datas),
            likes: 0,
            replies: []
          }));
          renderMessages();
        } else {
          console.error(data.error);
        }
      } catch (error) {
        console.error('Erro ao carregar mensagens:', error);
      }
    }

    function renderMessages() {
      const container = document.getElementById("messages-container");
      container.innerHTML = "";

      messages.forEach(msg => {
        container.appendChild(createMessageElement(msg));
      });
    }

    function createMessageElement(msg) {
      const div = document.createElement("div");
      div.className = "message";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.style.backgroundImage = `url(${msg.avatar})`;
      div.appendChild(avatar);

      const info = document.createElement("div");
      info.className = "message-info";

      const header = document.createElement("div");
      header.className = "message-header";

      const username = document.createElement("span");
      username.className = "username";
      username.textContent = msg.user;
      header.appendChild(username);

      const timestamp = document.createElement("span");
      timestamp.className = "timestamp";
      timestamp.textContent = formatTimestamp(msg.timestamp);
      header.appendChild(timestamp);

      info.appendChild(header);

      const messageText = document.createElement("p");
      messageText.className = "message-text";
      messageText.textContent = msg.message;
      info.appendChild(messageText);

      div.appendChild(info);
      return div;
    }

    function formatTimestamp(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);
      if (diffInSeconds < 60) return `${diffInSeconds}s atrás`;
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m atrás`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h atrás`;
      return `${Math.floor(diffInSeconds / 86400)}d atrás`;
    }

    document.getElementById("message-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const input = document.getElementById("mensagem_enviar");
      const nome = localStorage.getItem('nome')
      const newMessage = {
        user: nome, 
        avatar: "placeholder.png",
        message: input.value,
        timestamp: new Date(),
      };

      try {
        const response = await fetch('./controller/controllerChat.php', {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            usuario: newMessage.user,
            message: newMessage.message,
            problem: "Discussão"
          }),
        });

        const result = await response.json();
        if (result.status === 1) {
          messages.push(newMessage); 
          renderMessages();
          input.value = ""; 
        } else {
          console.error(result.error);
        }
      } catch (error) {
        console.error("Erro ao enviar mensagem:", error);
      }
    });

    loadMessages();

    setInterval(loadMessages, 1000);
  </script>
</body>
</html>